{% extends "base.html" %}

{% block title %}RevPi Control - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #005596;
        min-height: 100vh;
    }
    .header {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .logo {
        max-height: 50px;
        height: auto;
    }
    .user-info {
        color: #005596;
        font-weight: bold;
    }
    .logout-button {
        background-color: #e74a3b;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        margin-left: 15px;
    }
    .logout-button:hover {
        background-color: #c0392b;
        text-decoration: none;
        color: white;
    }
    .nav-tabs {
        background-color: white;
        padding: 0;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .tab-button {
        background-color: transparent;
        border: none;
        padding: 15px 30px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        color: #005596;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
    }
    .tab-button.active {
        background-color: #005596;
        color: white;
    }
    .tab-button:hover {
        background-color: #F3CB3C;
        color: #005596;
        text-decoration: none;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    .title {
        color: #005596;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
    }
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    .device-card {
        background-color: #f8f9fc;
        border: 2px solid #005596;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: transform 0.3s;
    }
    .device-card:hover {
        transform: translateY(-5px);
    }
    .device-name {
        font-size: 20px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 20px;
    }
    .toggle-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .toggle-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        min-width: 80px;
    }
    .toggle-button.on {
        background-color: #28a745;
        color: white;
    }
    .toggle-button.off {
        background-color: #dc3545;
        color: white;
    }
    .toggle-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .status-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 5px;
        font-size: 14px;
        min-height: 20px;
    }
    .status-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .status-message.loading {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .back-button {
        background-color: #F3CB3C;
        color: #005596;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 20px;
        transition: background-color 0.3s;
    }
    .back-button:hover {
        background-color: #e6b82e;
        text-decoration: none;
        color: #005596;
    }
    .status-bullet {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .status-bullet.on {
        background-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
    }
    .status-bullet.off {
        background-color: #dc3545;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
    }
    .status-bullet.error {
        background-color: #6c757d;
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.6);
    }
    .status-text {
        font-size: 14px;
        color: #005596;
        margin-bottom: 10px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block body %}
<div class="header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <div>
        <span class="user-info">Welcome, {{ session.username }}!</span>
        <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>
    </div>
</div>

<div class="nav-tabs">
    <a href="{{ url_for('main.service_monitor') }}" class="tab-button">Service Monitor & Config</a>
    <a href="{{ url_for('main.revpi_control') }}" class="tab-button active">RevPi Control</a>
</div>

<div class="container">
    <a href="{{ url_for('main.home') }}" class="back-button">← Back to Home</a>
    
    <h1 class="title">RevPi Device Control</h1>
    
    <div class="device-grid">
        {% for device_key, device_name in devices.items() %}
        <div class="device-card">
            <div class="device-name">{{ device_name }}</div>
            <div class="status-text">
                <span class="status-bullet error" id="bullet-{{ device_key }}"></span>
                <span id="status-text-{{ device_key }}">Loading...</span>
            </div>
            <div class="toggle-container">
                <button class="toggle-button on" onclick="toggleDevice('{{ device_key }}', 'on')" id="btn-{{ device_key }}-on">
                    Turn ON
                </button>
                <button class="toggle-button off" onclick="toggleDevice('{{ device_key }}', 'off')" id="btn-{{ device_key }}-off">
                    Turn OFF
                </button>
            </div>
            <div class="status-message" id="status-{{ device_key }}"></div>
        </div>
        {% endfor %}
    </div>
    
    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fc; border-radius: 8px; border-left: 4px solid #005596;">
        <strong>Commands:</strong><br>
        • Turn ON: piTest -w DeviceName,0<br>
        • Turn OFF: piTest -w DeviceName,1<br>
        • Get Status: piTest -r DeviceName<br>
        • Status updates automatically every 15 seconds<br>
        • All actions are logged for security
    </div>
</div>

<script>
// Start status monitoring when page loads with delay to prevent race conditions
let statusUpdateInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    // Delay initial status check to allow page to fully load
    setTimeout(() => {
        updateStatus();
    }, 500);
    
    // Update status every 15 seconds (increased interval to reduce load)
    setInterval(updateStatus, 15000);
});

function updateStatus() {
    // Prevent multiple simultaneous status requests
    if (statusUpdateInProgress) {
        return;
    }
    
    statusUpdateInProgress = true;
    
    fetch('/revpi-status')
    .then(response => response.json())
    .then(data => {
        statusUpdateInProgress = false;
        Object.keys(data).forEach(device => {
            const bullet = document.getElementById(`bullet-${device}`);
            const statusText = document.getElementById(`status-text-${device}`);
            
            if (bullet && statusText) {
                const deviceData = data[device];
                
                if (deviceData.status === 'ON') {
                    bullet.className = 'status-bullet on';
                    statusText.textContent = 'ON';
                } else if (deviceData.status === 'OFF') {
                    bullet.className = 'status-bullet off';
                    statusText.textContent = 'OFF';
                } else {
                    bullet.className = 'status-bullet error';
                    statusText.textContent = 'ERROR';
                }
            }
        });
    })
    .catch(error => {
        statusUpdateInProgress = false;
        console.error('Status update error:', error);
    });
}

function toggleDevice(device, action) {
    const onBtn = document.getElementById(`btn-${device}-on`);
    const offBtn = document.getElementById(`btn-${device}-off`);
    const statusDiv = document.getElementById(`status-${device}`);
    
    // Disable buttons and show loading
    onBtn.disabled = true;
    offBtn.disabled = true;
    statusDiv.className = 'status-message loading';
    statusDiv.textContent = `Turning ${action}...`;
    
    fetch('/revpi-toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device: device,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        if (data.success) {
            statusDiv.className = 'status-message success';
            statusDiv.textContent = data.message;
            
            // Update status immediately after successful toggle
            setTimeout(updateStatus, 500);
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.textContent = 'Error: ' + data.message;
        }
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    })
    .catch(error => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        console.error('Error:', error);
        statusDiv.className = 'status-message error';
        statusDiv.textContent = 'Error connecting to server';
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    });
}
</script>
</script>
{% endblock %}
