{% extends "base.html" %}

{% block title %}RevPi Control - {{ super() }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/toggle-switch.css') }}">
<style>
    /* Body and Background */
    body {
        margin: 0;
        padding: 20px;
        background-color: #005596;
        min-height: 100vh;
    }

    /* Top Header - Logo and User Info */
    .top-header {
        background-color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .logo {
        max-height: 50px;
        height: auto;
    }

    .user-section {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .user-info {
        color: #005596;
        font-weight: var(--font-bold);
        font-size: var(--text-base);
    }

    .logout-button {
        background-color: #e74a3b;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        font-weight: var(--font-medium);
        transition: all 0.2s ease;
    }

    .logout-button:hover {
        background-color: #c0392b;
        text-decoration: none;
        color: white;
    }

    /* Navigation Tabs - Minimalist Style */
    .nav-tabs-minimal {
        background-color: white;
        padding: 0;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .nav-tab-minimal {
        flex: 1;
        padding: 15px 20px;
        background-color: white;
        color: #005596;
        text-decoration: none;
        text-align: center;
        font-weight: var(--font-semibold);
        font-size: var(--text-base);
        border-right: 1px solid #e3e6f0;
        transition: all 0.2s ease;
    }

    .nav-tab-minimal:last-child {
        border-right: none;
    }

    .nav-tab-minimal:hover {
        background-color: #f8f9fc;
        text-decoration: none;
        color: #005596;
    }

    .nav-tab-minimal.active {
        background-color: #005596;
        color: white;
    }

    /* Minimalist RevPi Control Styles */
    .revpi-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-6);
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* Page Header - Clean and Simple */
    .page-header {
        margin-bottom: var(--space-8);
    }

    .page-title {
        font-size: var(--text-3xl);
        font-weight: var(--font-bold);
        margin: 0 0 var(--space-2) 0;
    }

    .page-subtitle {
        font-size: var(--text-base);
        opacity: 0.7;
        margin: 0;
    }

    /* Device Grid - Minimalist Layout */
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }

    /* Minimalist Device Card */
    .device-card-minimal {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--space-6);
        transition: all 0.3s ease;
    }

    .device-card-minimal:hover {
        box-shadow: var(--shadow-md);
    }

    /* Device Header - Simplified */
    .device-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-6);
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--border-color);
    }

    .device-title {
        font-size: var(--text-xl);
        font-weight: var(--font-semibold);
        margin: 0;
    }

    /* Control Section - Clean Toggle */
    .control-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    /* Status Display - Minimal */
    .status-display {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
    }

    /* Schedule Section - Collapsible */
    .schedule-section {
        margin-top: var(--space-6);
        padding-top: var(--space-6);
        border-top: 1px solid var(--border-color);
    }

    .schedule-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3);
        cursor: pointer;
        border-radius: var(--border-radius);
        transition: background-color 0.2s;
        user-select: none;
    }

    .schedule-header:hover {
        background-color: var(--bg-card-hover);
    }

    .schedule-header-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        margin: 0;
    }

    .schedule-toggle-icon {
        transition: transform 0.3s ease;
        font-size: var(--text-sm);
        opacity: 0.6;
    }

    .schedule-toggle-icon.collapsed {
        transform: rotate(-90deg);
    }

    /* Schedule Content */
    .schedule-content {
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        max-height: 1000px;
        opacity: 1;
        margin-top: var(--space-4);
    }

    .schedule-content.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
    }

    /* Day Selector - Clean Pills */
    .day-selector-minimal {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        justify-content: center;
        margin-bottom: var(--space-4);
    }

    .day-checkbox {
        display: none;
    }

    .day-pill {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        text-transform: uppercase;
        letter-spacing: var(--tracking-wide);
        border: 1px solid var(--border-color);
        border-radius: 9999px;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: var(--bg-card);
    }

    .day-pill:hover {
        background-color: var(--bg-card-hover);
    }

    .day-checkbox:checked + .day-pill {
        background-color: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
    }

    /* Time Inputs - Minimal */
    .time-inputs {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .time-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .time-label-minimal {
        font-size: var(--text-xs);
        text-transform: uppercase;
        font-weight: var(--font-semibold);
        opacity: 0.7;
        letter-spacing: var(--tracking-wide);
    }

    .time-input-minimal {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: var(--text-sm);
        width: 100px;
        text-align: center;
    }

    .time-input-minimal:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    /* Schedule Actions - Simplified Buttons */
    .schedule-actions {
        display: flex;
        gap: var(--space-2);
        justify-content: center;
        flex-wrap: wrap;
    }

    /* Schedule Status - Minimal Indicator */
    .schedule-status-minimal {
        margin-top: var(--space-4);
        padding: var(--space-3);
        border-radius: var(--border-radius);
        font-size: var(--text-xs);
        text-align: center;
        font-weight: var(--font-medium);
    }

    .schedule-status-minimal.active {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--status-success);
    }

    .schedule-status-minimal.inactive {
        background-color: var(--bg-card-hover);
        opacity: 0.7;
    }

    /* Schedule Info Display - Compact */
    .schedule-info {
        margin-top: var(--space-3);
        padding: var(--space-3);
        background-color: var(--bg-card-hover);
        border-radius: var(--border-radius);
        font-size: var(--text-xs);
        text-align: center;
    }

    /* Feedback Messages - Toast-like */
    .feedback-message {
        margin-top: var(--space-3);
        padding: var(--space-3);
        border-radius: var(--border-radius);
        font-size: var(--text-sm);
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .feedback-message.visible {
        opacity: 1;
    }

    .feedback-message.success {
        background-color: rgba(40, 167, 69, 0.1);
        color: var(--status-success);
    }

    .feedback-message.error {
        background-color: rgba(231, 74, 59, 0.1);
        color: var(--status-error);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .top-header {
            flex-direction: column;
            gap: var(--space-3);
            text-align: center;
        }

        .user-section {
            flex-direction: column;
            gap: var(--space-2);
        }

        .logo {
            max-height: 40px;
        }

        .nav-tabs-minimal {
            flex-direction: column;
        }

        .nav-tab-minimal {
            border-right: none;
            border-bottom: 1px solid #e3e6f0;
        }

        .nav-tab-minimal:last-child {
            border-bottom: none;
        }

        .revpi-container {
            padding: var(--space-4);
        }

        .page-title {
            font-size: var(--text-2xl);
        }

        .page-subtitle {
            font-size: var(--text-sm);
        }

        .device-grid {
            grid-template-columns: 1fr;
        }

        .time-inputs {
            flex-direction: column;
        }

        .schedule-actions {
            flex-direction: column;
        }

        .schedule-actions .btn {
            width: 100%;
        }
    }

    /* Remove visual clutter */
    .minimal-border {
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    /* Breathing room */
    .spacious {
        padding: var(--space-8);
    }
</style>
{% endblock %}

{% block body %}
<!-- Top Header with Logo and User Info -->
<div class="top-header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <div class="user-section">
        <span class="user-info">Welcome, {{ session.username }}!</span>
        <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="nav-tabs-minimal">
    <a href="{{ url_for('main.service_monitor') }}" class="nav-tab-minimal">Service Monitor & Config</a>
    <a href="{{ url_for('main.revpi_control') }}" class="nav-tab-minimal active">RevPi Control</a>
</div>

<div class="revpi-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Device Control</h1>
        <p class="page-subtitle">Manage and schedule your RevPi devices</p>
    </div>

    <!-- Device Grid -->
    <div class="device-grid">
        {% for device_key, device_name in devices.items() %}
        <div class="device-card-minimal">
            <!-- Device Header -->
            <div class="device-header">
                <h2 class="device-title">{{ device_name }}</h2>
                <span class="status-display">
                    <span class="status-dot status-dot-unknown" id="bullet-{{ device_key }}"></span>
                    <span id="status-text-{{ device_key }}">Loading</span>
                </span>
            </div>

            <!-- Control Section -->
            <div class="control-section">
                <label class="toggle-switch" id="switch-{{ device_key }}">
                    <input type="checkbox" id="toggle-{{ device_key }}" onchange="handleToggleSwitch('{{ device_key }}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Feedback Message -->
            <div class="feedback-message" id="status-{{ device_key }}"></div>

            <!-- Schedule Section (only for RelayLight) -->
            {% if device_key == 'RelayLight' %}
            <div class="schedule-section">
                <div class="schedule-header" onclick="toggleScheduleVisibility('{{ device_key }}')">
                    <h3 class="schedule-header-title">Schedule</h3>
                    <span class="schedule-toggle-icon" id="schedule-icon-{{ device_key }}">â–¼</span>
                </div>

                <div class="schedule-content" id="schedule-controls-{{ device_key }}">
                    <!-- Day Selector -->
                    <div class="day-selector-minimal">
                        <input type="checkbox" id="day-mon-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-mon-{{ device_key }}" class="day-pill">Mon</label>

                        <input type="checkbox" id="day-tue-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-tue-{{ device_key }}" class="day-pill">Tue</label>

                        <input type="checkbox" id="day-wed-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-wed-{{ device_key }}" class="day-pill">Wed</label>

                        <input type="checkbox" id="day-thu-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-thu-{{ device_key }}" class="day-pill">Thu</label>

                        <input type="checkbox" id="day-fri-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-fri-{{ device_key }}" class="day-pill">Fri</label>

                        <input type="checkbox" id="day-sat-{{ device_key }}" class="day-checkbox">
                        <label for="day-sat-{{ device_key }}" class="day-pill">Sat</label>

                        <input type="checkbox" id="day-sun-{{ device_key }}" class="day-checkbox">
                        <label for="day-sun-{{ device_key }}" class="day-pill">Sun</label>
                    </div>

                    <!-- Time Inputs -->
                    <div class="time-inputs">
                        <div class="time-group">
                            <span class="time-label-minimal">Start</span>
                            <input type="time" class="time-input-minimal" id="start-time-{{ device_key }}" value="08:00">
                        </div>
                        <div class="time-group">
                            <span class="time-label-minimal">End</span>
                            <input type="time" class="time-input-minimal" id="end-time-{{ device_key }}" value="18:00">
                        </div>
                    </div>

                    <!-- Schedule Actions -->
                    <div class="schedule-actions">
                        <button class="btn btn-primary btn-sm" onclick="saveSchedule('{{ device_key }}')" id="save-schedule-{{ device_key }}">
                            Save
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="enableSchedule('{{ device_key }}')" id="enable-schedule-{{ device_key }}">
                            Enable
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="disableSchedule('{{ device_key }}')" id="disable-schedule-{{ device_key }}" disabled>
                            Disable
                        </button>
                    </div>

                    <!-- Schedule Status -->
                    <div class="schedule-status-minimal inactive" id="schedule-status-{{ device_key }}">
                        Inactive
                    </div>

                    <!-- Schedule Info -->
                    <div class="schedule-info" id="current-schedule-{{ device_key }}" style="display: none;">
                        <span id="schedule-details-{{ device_key }}">No schedule</span>
                    </div>

                    <!-- Device Time Display -->
                    <div class="schedule-info" id="device-time-{{ device_key }}" style="display: none;">
                        <span id="device-time-display-{{ device_key }}">Loading...</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Start status monitoring when page loads with delay to prevent race conditions
let statusUpdateInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    // Delay initial status check to allow page to fully load
    setTimeout(() => {
        updateStatus();
    }, 500);
    
    // Update status every 15 seconds (increased interval to reduce load)
    setInterval(updateStatus, 15000);
});

function updateStatus() {
    // Prevent multiple simultaneous status requests
    if (statusUpdateInProgress) {
        return;
    }

    statusUpdateInProgress = true;

    fetch('/revpi-status')
    .then(response => response.json())
    .then(data => {
        statusUpdateInProgress = false;
        Object.keys(data).forEach(device => {
            const bullet = document.getElementById(`bullet-${device}`);
            const statusText = document.getElementById(`status-text-${device}`);
            const toggleSwitch = document.getElementById(`toggle-${device}`);

            if (bullet && statusText) {
                const deviceData = data[device];

                if (deviceData.status === 'ON') {
                    bullet.className = 'status-dot status-dot-active';
                    statusText.textContent = 'ON';
                    if (toggleSwitch) toggleSwitch.checked = true;
                } else if (deviceData.status === 'OFF') {
                    bullet.className = 'status-dot status-dot-inactive';
                    statusText.textContent = 'OFF';
                    if (toggleSwitch) toggleSwitch.checked = false;
                } else {
                    bullet.className = 'status-dot status-dot-unknown';
                    statusText.textContent = 'Unknown';
                    if (toggleSwitch) toggleSwitch.checked = false;
                }
            }
        });
    })
    .catch(error => {
        statusUpdateInProgress = false;
        console.error('Status update error:', error);
    });
}

// Handle toggle switch changes with minimalist feedback
function handleToggleSwitch(device, isChecked) {
    const action = isChecked ? 'on' : 'off';
    const toggleSwitch = document.getElementById(`toggle-${device}`);
    const statusDiv = document.getElementById(`status-${device}`);

    // Disable toggle
    if (toggleSwitch) toggleSwitch.disabled = true;

    // Show feedback
    if (statusDiv) {
        statusDiv.className = 'feedback-message visible';
        statusDiv.textContent = `Switching ${action.toUpperCase()}...`;
    }

    fetch('/revpi-toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device: device,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable toggle
        if (toggleSwitch) toggleSwitch.disabled = false;

        if (data.success) {
            if (statusDiv) {
                statusDiv.className = 'feedback-message success visible';
                statusDiv.textContent = `Switched ${action.toUpperCase()}`;
            }

            // Update status immediately after successful toggle
            setTimeout(updateStatus, 500);
        } else {
            if (statusDiv) {
                statusDiv.className = 'feedback-message error visible';
                statusDiv.textContent = data.message || 'Operation failed';
            }

            // Revert toggle switch on error
            if (toggleSwitch) toggleSwitch.checked = !isChecked;
        }

        // Clear message after 3 seconds
        if (statusDiv) {
            setTimeout(() => {
                statusDiv.classList.remove('visible');
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'feedback-message';
                }, 300);
            }, 3000);
        }
    })
    .catch(error => {
        // Re-enable toggle
        if (toggleSwitch) {
            toggleSwitch.disabled = false;
            toggleSwitch.checked = !isChecked;
        }

        console.error('Error:', error);
        if (statusDiv) {
            statusDiv.className = 'feedback-message error visible';
            statusDiv.textContent = 'Connection failed';
        }

        // Clear message after 3 seconds
        if (statusDiv) {
            setTimeout(() => {
                statusDiv.classList.remove('visible');
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'feedback-message';
                }, 300);
            }, 3000);
        }
    });
}

function toggleDevice(device, action) {
    const onBtn = document.getElementById(`btn-${device}-on`);
    const offBtn = document.getElementById(`btn-${device}-off`);
    const statusDiv = document.getElementById(`status-${device}`);
    
    // Disable buttons and show loading
    onBtn.disabled = true;
    offBtn.disabled = true;
    statusDiv.className = 'status-message loading';
    statusDiv.textContent = `Turning ${action}...`;
    
    fetch('/revpi-toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device: device,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        if (data.success) {
            statusDiv.className = 'status-message success';
            statusDiv.textContent = data.message;
            
            // Update status immediately after successful toggle
            setTimeout(updateStatus, 500);
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.textContent = 'Error: ' + data.message;
        }
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    })
    .catch(error => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        console.error('Error:', error);
        statusDiv.className = 'status-message error';
        statusDiv.textContent = 'Error connecting to server';
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    });
}

// Daily schedule functionality
let deviceSchedules = {};
let scheduleCheckers = {};
let scheduleVisibility = {}; // Track visibility state for each device

// Toggle schedule visibility with minimalist animation
function toggleScheduleVisibility(device) {
    const scheduleControls = document.getElementById(`schedule-controls-${device}`);
    const scheduleIcon = document.getElementById(`schedule-icon-${device}`);

    if (!scheduleControls) return;

    // Toggle visibility state
    const isCurrentlyVisible = !scheduleVisibility[device];
    scheduleVisibility[device] = isCurrentlyVisible;

    if (isCurrentlyVisible) {
        // Show schedule controls
        scheduleControls.classList.remove('collapsed');
        if (scheduleIcon) scheduleIcon.classList.remove('collapsed');
    } else {
        // Hide schedule controls
        scheduleControls.classList.add('collapsed');
        if (scheduleIcon) scheduleIcon.classList.add('collapsed');
    }

    // Save visibility state to localStorage
    localStorage.setItem('schedule_visibility', JSON.stringify(scheduleVisibility));
}

// Load saved visibility state
function loadScheduleVisibility() {
    const savedVisibility = localStorage.getItem('schedule_visibility');
    if (savedVisibility) {
        try {
            scheduleVisibility = JSON.parse(savedVisibility);
            
            // Apply saved visibility states
            Object.keys(scheduleVisibility).forEach(device => {
                const scheduleControls = document.getElementById(`schedule-controls-${device}`);
                const scheduleIcon = document.getElementById(`schedule-icon-${device}`);

                if (scheduleControls) {
                    if (scheduleVisibility[device]) {
                        // Show
                        scheduleControls.classList.remove('collapsed');
                        if (scheduleIcon) scheduleIcon.classList.remove('collapsed');
                    } else {
                        // Hide
                        scheduleControls.classList.add('collapsed');
                        if (scheduleIcon) scheduleIcon.classList.add('collapsed');
                    }
                }
            });
        } catch (e) {
            console.error('Error loading schedule visibility:', e);
            scheduleVisibility = {};
        }
    }
    
    // Set default visibility for devices not in saved state
    const allScheduleContainers = document.querySelectorAll('[id^="schedule-controls-"]');
    allScheduleContainers.forEach(container => {
        const device = container.id.replace('schedule-controls-', '');
        if (scheduleVisibility[device] === undefined) {
            scheduleVisibility[device] = true; // Default to visible
        }
    });
}

// Load saved schedules from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load visibility state first
    loadScheduleVisibility();
    // Then load and initialize any saved schedules
    loadSavedSchedules();
});

function loadSavedSchedules() {
    // Load schedules from server instead of localStorage
    fetch('/revpi-schedule/all')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const serverSchedules = data.schedules;
            deviceSchedules = {};
            
            // Convert server format to client format and restore UI
            Object.keys(serverSchedules).forEach(deviceId => {
                const serverSchedule = serverSchedules[deviceId];
                const clientSchedule = {
                    days: serverSchedule.days,
                    startTime: serverSchedule.start_time,
                    endTime: serverSchedule.end_time,
                    enabled: serverSchedule.enabled
                };
                
                deviceSchedules[deviceId] = clientSchedule;
                
                // Restore UI state
                restoreScheduleUI(deviceId, clientSchedule);
                
                // If schedule is enabled, start it
                if (clientSchedule.enabled) {
                    enableSchedule(deviceId, false); // false = don't save to server again
                }
            });
        } else {
            console.log('No schedules found on server or error loading schedules');
            deviceSchedules = {};
        }
    })
    .catch(error => {
        console.error('Error loading schedules from server:', error);
        // Fallback to localStorage if server fails
        console.log('Falling back to localStorage...');
        const savedSchedules = localStorage.getItem('revpi_schedules');
        if (savedSchedules) {
            try {
                deviceSchedules = JSON.parse(savedSchedules);
                // Restore UI state for each saved schedule
                Object.keys(deviceSchedules).forEach(device => {
                    const schedule = deviceSchedules[device];
                    if (schedule) {
                        restoreScheduleUI(device, schedule);
                        if (schedule.enabled) {
                            enableSchedule(device, false); // false = don't save again
                        }
                    }
                });
            } catch (e) {
                console.error('Error loading saved schedules from localStorage:', e);
                deviceSchedules = {};
            }
        } else {
            deviceSchedules = {};
        }
    });
}

function restoreScheduleUI(device, schedule) {
    // Restore day checkboxes
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    days.forEach(day => {
        const checkbox = document.getElementById(`day-${day}-${device}`);
        if (checkbox && schedule.days) {
            checkbox.checked = schedule.days.includes(day);
        }
    });
    
    // Restore time inputs
    const startTimeInput = document.getElementById(`start-time-${device}`);
    const endTimeInput = document.getElementById(`end-time-${device}`);
    if (startTimeInput && schedule.startTime) startTimeInput.value = schedule.startTime;
    if (endTimeInput && schedule.endTime) endTimeInput.value = schedule.endTime;
    
    // Update schedule display
    updateScheduleDisplay(device, schedule);
}

function saveSchedule(device) {
    const startTime = document.getElementById(`start-time-${device}`).value;
    const endTime = document.getElementById(`end-time-${device}`).value;
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Validate times
    if (!startTime || !endTime) {
        alert('Please set both start and end times');
        return;
    }
    
    if (startTime >= endTime) {
        alert('End time must be after start time');
        return;
    }
    
    // Get selected days
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const selectedDays = days.filter(day => 
        document.getElementById(`day-${day}-${device}`).checked
    );
    
    if (selectedDays.length === 0) {
        alert('Please select at least one day');
        return;
    }
    
    // Show saving status
    statusDiv.className = 'schedule-status warning';
    statusDiv.textContent = 'Saving schedule...';
    
    // Save schedule to server
    const scheduleData = {
        device_id: device,
        start_time: startTime,
        end_time: endTime,
        days: selectedDays,
        enabled: false
    };
    
    fetch('/revpi-schedule/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update local cache
            deviceSchedules[device] = {
                days: selectedDays,
                startTime: startTime,
                endTime: endTime,
                enabled: false
            };
            
            // Update UI
            statusDiv.className = 'schedule-status-minimal inactive';
            statusDiv.textContent = 'Saved - Click Enable';
            updateScheduleDisplay(device, deviceSchedules[device]);

            // Clear message after 3 seconds
            setTimeout(() => {
                if (!deviceSchedules[device].enabled) {
                    statusDiv.className = 'schedule-status-minimal inactive';
                    statusDiv.textContent = 'Inactive';
                }
            }, 3000);
        } else {
            statusDiv.className = 'schedule-status-minimal inactive';
            statusDiv.textContent = `Error: ${data.message}`;
            setTimeout(() => {
                statusDiv.className = 'schedule-status-minimal inactive';
                statusDiv.textContent = 'Inactive';
            }, 5000);
        }
    })
    .catch(error => {
        console.error('Error saving schedule:', error);
        statusDiv.className = 'schedule-status-minimal inactive';
        statusDiv.textContent = 'Save failed';
        setTimeout(() => {
            statusDiv.className = 'schedule-status-minimal inactive';
            statusDiv.textContent = 'Inactive';
        }, 5000);
    });
}

function enableSchedule(device, shouldSave = true) {
    const schedule = deviceSchedules[device];
    if (!schedule) {
        alert('Please save a schedule first');
        return;
    }
    
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    if (shouldSave) {
        // Enable schedule on server
        statusDiv.textContent = 'Enabling schedule...';
        
        fetch('/revpi-schedule/enable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: device,
                enabled: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                enableScheduleUI(device);
            } else {
                statusDiv.className = 'schedule-status-minimal inactive';
                statusDiv.textContent = `Error: ${data.message}`;
                setTimeout(() => {
                    statusDiv.className = 'schedule-status-minimal inactive';
                    statusDiv.textContent = 'Inactive';
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error enabling schedule:', error);
            statusDiv.className = 'schedule-status-minimal inactive';
            statusDiv.textContent = 'Enable failed';
            setTimeout(() => {
                statusDiv.className = 'schedule-status-minimal inactive';
                statusDiv.textContent = 'Inactive';
            }, 3000);
        });
    } else {
        // Called from page load - just update UI
        enableScheduleUI(device);
    }
}

function enableScheduleUI(device) {
    const schedule = deviceSchedules[device];
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Update local schedule state
    schedule.enabled = true;
    
    // Update UI
    enableBtn.disabled = true;
    disableBtn.disabled = false;
    statusDiv.className = 'schedule-status-minimal active';
    statusDiv.textContent = 'Active';

    // Show device time display
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'block';
    }

    // Start schedule checker
    startScheduleChecker(device);

    // Initial status update (immediate)
    setTimeout(() => {
        updateScheduleStatus(device);
    }, 1000);
}

function disableSchedule(device) {
    const schedule = deviceSchedules[device];
    if (!schedule) return;
    
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Disable schedule on server
    statusDiv.textContent = 'Disabling schedule...';
    
    fetch('/revpi-schedule/enable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device_id: device,
            enabled: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            disableScheduleUI(device);
        } else {
            statusDiv.className = 'schedule-status-minimal active';
            statusDiv.textContent = `Error: ${data.message}`;
            setTimeout(() => {
                statusDiv.className = 'schedule-status-minimal active';
                statusDiv.textContent = 'Active';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error disabling schedule:', error);
        statusDiv.className = 'schedule-status-minimal active';
        statusDiv.textContent = 'Disable failed';
        setTimeout(() => {
            statusDiv.className = 'schedule-status-minimal active';
            statusDiv.textContent = 'Active';
        }, 3000);
    });
}

function disableScheduleUI(device) {
    const schedule = deviceSchedules[device];
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Update local schedule state
    schedule.enabled = false;
    
    // Stop schedule checker
    if (scheduleCheckers[device]) {
        clearInterval(scheduleCheckers[device]);
        delete scheduleCheckers[device];
    }
    
    // Update UI
    enableBtn.disabled = false;
    disableBtn.disabled = true;
    statusDiv.className = 'schedule-status-minimal inactive';
    statusDiv.textContent = 'Inactive';

    // Hide device time display
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'none';
    }
}

function startScheduleChecker(device) {
    // Clear existing checker
    if (scheduleCheckers[device]) {
        clearInterval(scheduleCheckers[device]);
    }
    
    // Start with frequent checks (every 30 seconds) for the first 5 minutes
    // then reduce to every minute for ongoing monitoring
    let checkCount = 0;
    const maxFrequentChecks = 10; // 5 minutes worth at 30-second intervals
    
    scheduleCheckers[device] = setInterval(() => {
        updateScheduleStatus(device);
        checkCount++;
        
        // After frequent checks, switch to less frequent checking
        if (checkCount >= maxFrequentChecks) {
            clearInterval(scheduleCheckers[device]);
            // Switch to minute-based checking
            scheduleCheckers[device] = setInterval(() => {
                updateScheduleStatus(device);
            }, 60000);
        }
    }, 30000); // Check every 30 seconds initially
}

function updateScheduleStatus(device) {
    const schedule = deviceSchedules[device];
    if (!schedule || !schedule.enabled) return;
    
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    const deviceTimeDisplay = document.getElementById(`device-time-display-${device}`);
    
    // Show device time display when schedule is active
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'block';
    }
    
    // Fetch device time from RevPi
    fetch('/revpi-time')
    .then(response => response.json())
    .then(timeData => {
        if (timeData.success) {
            const currentDay = timeData.day; // 'mon', 'tue', etc.
            const currentTime = timeData.time; // 'HH:MM'
            
            // Update device time display
            if (deviceTimeDisplay) {
                deviceTimeDisplay.textContent = `${timeData.formatted_time} (${currentDay.toUpperCase()})`;
            }
            
            processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
        } else {
            // Fallback to client time if server time fails
            console.warn('Failed to get device time, falling back to client time');
            if (deviceTimeDisplay) {
                deviceTimeDisplay.textContent = 'Device time unavailable - using client time';
            }
            
            const now = new Date();
            const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            
            processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
        }
    })
    .catch(error => {
        console.error('Error fetching device time:', error);
        if (deviceTimeDisplay) {
            deviceTimeDisplay.textContent = 'Error getting device time';
        }
        
        // Fallback to client time on error
        const now = new Date();
        const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
        
        processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
    });
}

function processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv) {
    
    // Check if today is a scheduled day
    if (!schedule.days.includes(currentDay)) {
        statusDiv.textContent = `Off day`;
        // Turn off on non-scheduled days
        executeScheduleAction(device, 'off');
        return;
    }

    // Check if current time is within schedule
    const isInSchedule = currentTime >= schedule.startTime && currentTime < schedule.endTime;

    if (isInSchedule) {
        statusDiv.textContent = `Active (${schedule.startTime}-${schedule.endTime})`;
        // Auto-turn on during scheduled time
        executeScheduleAction(device, 'on');
    } else {
        statusDiv.textContent = `Standby (${schedule.startTime}-${schedule.endTime})`;
        // Auto-turn off outside scheduled time
        executeScheduleAction(device, 'off');
    }
}

function executeScheduleAction(device, action) {
    // Get current device status to avoid unnecessary toggles
    const currentStatusElement = document.getElementById(`status-text-${device}`);
    const currentStatus = currentStatusElement ? currentStatusElement.textContent : '';
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Only execute if we need to change the state
    const shouldExecute = (action === 'on' && currentStatus !== 'ON') || 
                         (action === 'off' && currentStatus !== 'OFF');
    
    if (shouldExecute) {
        // Show that action is being taken
        const originalText = statusDiv.textContent;
        statusDiv.textContent = `Executing: Turning ${action.toUpperCase()}...`;
        
        // Use a simplified version of toggleDevice that doesn't interfere with UI
        fetch('/revpi-toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device: device,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Schedule executed: ${device} turned ${action.toUpperCase()}`);
                // Update status immediately
                setTimeout(updateStatus, 1000);
                
                // Restore status message after action
                setTimeout(() => {
                    if (statusDiv.textContent.includes('Executing:')) {
                        updateScheduleStatus(device);
                    }
                }, 2000);
            } else {
                console.error(`Schedule execution failed for ${device}: ${data.message}`);
                statusDiv.textContent = `Error: ${data.message}`;
                // Restore original status after error
                setTimeout(() => {
                    statusDiv.textContent = originalText;
                }, 3000);
            }
        })
        .catch(error => {
            console.error(`Schedule execution error for ${device}:`, error);
            statusDiv.textContent = 'Error: Connection failed';
            // Restore original status after error
            setTimeout(() => {
                statusDiv.textContent = originalText;
            }, 3000);
        });
    }
}

function updateScheduleDisplay(device, schedule) {
    const scheduleDiv = document.getElementById(`current-schedule-${device}`);
    const detailsSpan = document.getElementById(`schedule-details-${device}`);
    
    if (schedule && schedule.days && schedule.startTime && schedule.endTime) {
        const dayNames = {
            'mon': 'Mon', 'tue': 'Tue', 'wed': 'Wed', 'thu': 'Thu',
            'fri': 'Fri', 'sat': 'Sat', 'sun': 'Sun'
        };
        
        const dayStr = schedule.days.map(day => dayNames[day]).join(', ');
        detailsSpan.textContent = `${dayStr}: ${schedule.startTime} - ${schedule.endTime}`;
        scheduleDiv.style.display = 'block';
    } else {
        detailsSpan.textContent = 'No schedule set';
        scheduleDiv.style.display = 'none';
    }
}

// Stop all schedule checkers when page is unloaded
window.addEventListener('beforeunload', function() {
    Object.keys(scheduleCheckers).forEach(device => {
        if (scheduleCheckers[device]) {
            clearInterval(scheduleCheckers[device]);
        }
    });
});
</script>
{% endblock %}
