{% extends "base.html" %}

{% block title %}RevPi Control - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #005596;
        min-height: 100vh;
    }
    .header {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .logo {
        max-height: 50px;
        height: auto;
    }
    .user-info {
        color: #005596;
        font-weight: bold;
    }
    .logout-button {
        background-color: #e74a3b;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        margin-left: 15px;
    }
    .logout-button:hover {
        background-color: #c0392b;
        text-decoration: none;
        color: white;
    }
    .nav-tabs {
        background-color: white;
        padding: 0;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .tab-button {
        background-color: transparent;
        border: none;
        padding: 15px 30px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        color: #005596;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
    }
    .tab-button.active {
        background-color: #005596;
        color: white;
    }
    .tab-button:hover {
        background-color: #F3CB3C;
        color: #005596;
        text-decoration: none;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    .title {
        color: #005596;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
    }
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    .device-card {
        background-color: #f8f9fc;
        border: 2px solid #005596;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: transform 0.3s;
    }
    .device-card:hover {
        transform: translateY(-5px);
    }
    .device-name {
        font-size: 20px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 20px;
    }
    .toggle-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .toggle-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        min-width: 80px;
    }
    .toggle-button.on {
        background-color: #28a745;
        color: white;
    }
    .toggle-button.off {
        background-color: #dc3545;
        color: white;
    }
    .toggle-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .status-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 5px;
        font-size: 14px;
        min-height: 20px;
    }
    .status-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .status-message.loading {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .back-button {
        background-color: #F3CB3C;
        color: #005596;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 20px;
        transition: background-color 0.3s;
    }
    .back-button:hover {
        background-color: #e6b82e;
        text-decoration: none;
        color: #005596;
    }
    .status-bullet {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .status-bullet.on {
        background-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
    }
    .status-bullet.off {
        background-color: #dc3545;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
    }
    .status-bullet.error {
        background-color: #6c757d;
        box-shadow: 0 0 10px rgba(108, 117, 125, 0.6);
    }
    .status-text {
        font-size: 14px;
        color: #005596;
        margin-bottom: 10px;
        font-weight: bold;
    }
    .schedule-container {
        margin-top: 15px;
        padding: 15px;
        background-color: #f0f8ff;
        border-radius: 8px;
        border: 1px solid #005596;
    }
    .schedule-title {
        font-size: 14px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 15px;
        text-align: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.3s ease;
        position: relative;
        user-select: none;
    }
    .schedule-title:hover {
        background-color: #e7f3ff;
        color: #003d6b;
    }
    .schedule-title::after {
        content: '▼';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        transition: transform 0.3s ease;
    }
    .schedule-title.collapsed::after {
        transform: translateY(-50%) rotate(-90deg);
    }
    .schedule-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        max-height: 1000px;
        opacity: 1;
    }
    .schedule-controls.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding: 0;
    }
    .time-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .time-input {
        width: 70px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        text-align: center;
        font-size: 12px;
    }
    .time-label {
        font-size: 12px;
        color: #005596;
        font-weight: bold;
        min-width: 60px;
    }
    .schedule-button {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
        transition: all 0.3s;
        margin: 2px;
    }
    .schedule-button.enable {
        background-color: #28a745;
        color: white;
    }
    .schedule-button.enable:hover {
        background-color: #218838;
    }
    .schedule-button.disable {
        background-color: #dc3545;
        color: white;
    }
    .schedule-button.disable:hover {
        background-color: #c82333;
    }
    .schedule-button.save {
        background-color: #007bff;
        color: white;
    }
    .schedule-button.save:hover {
        background-color: #0056b3;
    }
    .schedule-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .schedule-status {
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        padding: 5px;
        border-radius: 3px;
        min-height: 20px;
    }
    .schedule-status.active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .schedule-status.inactive {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    .schedule-status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    .current-schedule {
        font-size: 11px;
        color: #005596;
        background-color: #e7f3ff;
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        border-left: 3px solid #005596;
    }
    .day-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
        margin: 10px 0;
    }
    .day-checkbox {
        display: none;
    }
    .day-label {
        padding: 4px 8px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        color: #6c757d;
        transition: all 0.3s;
    }
    .day-checkbox:checked + .day-label {
        background-color: #005596;
        color: white;
        border-color: #005596;
    }
    .day-label:hover {
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block body %}
<div class="header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <div>
        <span class="user-info">Welcome, {{ session.username }}!</span>
        <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>
    </div>
</div>

<div class="nav-tabs">
    <a href="{{ url_for('main.service_monitor') }}" class="tab-button">Service Monitor & Config</a>
    <a href="{{ url_for('main.revpi_control') }}" class="tab-button active">RevPi Control</a>
</div>

<div class="container">
    <a href="{{ url_for('main.home') }}" class="back-button">← Back to Home</a>
    
    <h1 class="title">RevPi Device Control</h1>
    
    <div class="device-grid">
        {% for device_key, device_name in devices.items() %}
        <div class="device-card">
            <div class="device-name">{{ device_name }}</div>
            <div class="status-text">
                <span class="status-bullet error" id="bullet-{{ device_key }}"></span>
                <span id="status-text-{{ device_key }}">Loading...</span>
            </div>
            <div class="toggle-container">
                <button class="toggle-button on" onclick="toggleDevice('{{ device_key }}', 'on')" id="btn-{{ device_key }}-on">
                    Turn ON
                </button>
                <button class="toggle-button off" onclick="toggleDevice('{{ device_key }}', 'off')" id="btn-{{ device_key }}-off">
                    Turn OFF
                </button>
            </div>
            
            {% if device_key == 'RelayLight' %}
            <div class="schedule-container">
                <div class="schedule-title" onclick="toggleScheduleVisibility('{{ device_key }}')">Daily Schedule</div>
                <div class="schedule-controls" id="schedule-controls-{{ device_key }}">
                    <div class="day-selector">
                        <input type="checkbox" id="day-mon-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-mon-{{ device_key }}" class="day-label">Mon</label>
                        
                        <input type="checkbox" id="day-tue-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-tue-{{ device_key }}" class="day-label">Tue</label>
                        
                        <input type="checkbox" id="day-wed-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-wed-{{ device_key }}" class="day-label">Wed</label>
                        
                        <input type="checkbox" id="day-thu-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-thu-{{ device_key }}" class="day-label">Thu</label>
                        
                        <input type="checkbox" id="day-fri-{{ device_key }}" class="day-checkbox" checked>
                        <label for="day-fri-{{ device_key }}" class="day-label">Fri</label>
                        
                        <input type="checkbox" id="day-sat-{{ device_key }}" class="day-checkbox">
                        <label for="day-sat-{{ device_key }}" class="day-label">Sat</label>
                        
                        <input type="checkbox" id="day-sun-{{ device_key }}" class="day-checkbox">
                        <label for="day-sun-{{ device_key }}" class="day-label">Sun</label>
                    </div>
                    
                    <div class="time-input-group">
                        <span class="time-label">Start:</span>
                        <input type="time" class="time-input" id="start-time-{{ device_key }}" value="08:00">
                        <span class="time-label">End:</span>
                        <input type="time" class="time-input" id="end-time-{{ device_key }}" value="18:00">
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="schedule-button save" onclick="saveSchedule('{{ device_key }}')" id="save-schedule-{{ device_key }}">
                            Save Schedule
                        </button>
                        <button class="schedule-button enable" onclick="enableSchedule('{{ device_key }}')" id="enable-schedule-{{ device_key }}">
                            Enable
                        </button>
                        <button class="schedule-button disable" onclick="disableSchedule('{{ device_key }}')" id="disable-schedule-{{ device_key }}" disabled>
                            Disable
                        </button>
                    </div>
                    
                    <div class="schedule-status inactive" id="schedule-status-{{ device_key }}">
                        Schedule Inactive
                    </div>
                    
                    <div class="current-schedule" id="current-schedule-{{ device_key }}" style="display: none;">
                        <strong>Current Schedule:</strong><br>
                        <span id="schedule-details-{{ device_key }}">No schedule set</span>
                    </div>
                    
                    <div class="current-schedule" id="device-time-{{ device_key }}" style="display: none; margin-top: 8px;">
                        <strong>Device Time:</strong><br>
                        <span id="device-time-display-{{ device_key }}">Loading...</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="status-message" id="status-{{ device_key }}"></div>
        </div>
        {% endfor %}
    </div>
    
    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fc; border-radius: 8px; border-left: 4px solid #005596;">
        <strong>Commands:</strong><br>
        • Turn ON: piTest -w DeviceName,0<br>
        • Turn OFF: piTest -w DeviceName,1<br>
        • Get Status: piTest -r DeviceName<br>
        • Status updates automatically every 15 seconds<br>
        • <strong>RelayLight Daily Schedule:</strong> Set daily ON/OFF times for specific weekdays<br>
        • Schedule runs automatically based on RevPi device system time<br>
        • Device time is displayed when schedule is active<br>
        • <strong>Schedules are saved permanently on the server</strong><br>
        • All actions are logged for security
    </div>
</div>

<script>
// Start status monitoring when page loads with delay to prevent race conditions
let statusUpdateInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    // Delay initial status check to allow page to fully load
    setTimeout(() => {
        updateStatus();
    }, 500);
    
    // Update status every 15 seconds (increased interval to reduce load)
    setInterval(updateStatus, 15000);
});

function updateStatus() {
    // Prevent multiple simultaneous status requests
    if (statusUpdateInProgress) {
        return;
    }
    
    statusUpdateInProgress = true;
    
    fetch('/revpi-status')
    .then(response => response.json())
    .then(data => {
        statusUpdateInProgress = false;
        Object.keys(data).forEach(device => {
            const bullet = document.getElementById(`bullet-${device}`);
            const statusText = document.getElementById(`status-text-${device}`);
            
            if (bullet && statusText) {
                const deviceData = data[device];
                
                if (deviceData.status === 'ON') {
                    bullet.className = 'status-bullet on';
                    statusText.textContent = 'ON';
                } else if (deviceData.status === 'OFF') {
                    bullet.className = 'status-bullet off';
                    statusText.textContent = 'OFF';
                } else {
                    bullet.className = 'status-bullet error';
                    statusText.textContent = 'ERROR';
                }
            }
        });
    })
    .catch(error => {
        statusUpdateInProgress = false;
        console.error('Status update error:', error);
    });
}

function toggleDevice(device, action) {
    const onBtn = document.getElementById(`btn-${device}-on`);
    const offBtn = document.getElementById(`btn-${device}-off`);
    const statusDiv = document.getElementById(`status-${device}`);
    
    // Disable buttons and show loading
    onBtn.disabled = true;
    offBtn.disabled = true;
    statusDiv.className = 'status-message loading';
    statusDiv.textContent = `Turning ${action}...`;
    
    fetch('/revpi-toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device: device,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        if (data.success) {
            statusDiv.className = 'status-message success';
            statusDiv.textContent = data.message;
            
            // Update status immediately after successful toggle
            setTimeout(updateStatus, 500);
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.textContent = 'Error: ' + data.message;
        }
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    })
    .catch(error => {
        // Re-enable buttons
        onBtn.disabled = false;
        offBtn.disabled = false;
        
        console.error('Error:', error);
        statusDiv.className = 'status-message error';
        statusDiv.textContent = 'Error connecting to server';
        
        // Clear message after 5 seconds
        setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }, 5000);
    });
}

// Daily schedule functionality
let deviceSchedules = {};
let scheduleCheckers = {};
let scheduleVisibility = {}; // Track visibility state for each device

// Toggle schedule visibility
function toggleScheduleVisibility(device) {
    const scheduleControls = document.getElementById(`schedule-controls-${device}`);
    const scheduleTitle = document.querySelector(`#schedule-controls-${device}`).previousElementSibling;
    
    if (!scheduleControls || !scheduleTitle) return;
    
    // Toggle visibility state
    const isCurrentlyVisible = !scheduleVisibility[device];
    scheduleVisibility[device] = isCurrentlyVisible;
    
    if (isCurrentlyVisible) {
        // Show schedule controls
        scheduleControls.classList.remove('collapsed');
        scheduleTitle.classList.remove('collapsed');
    } else {
        // Hide schedule controls
        scheduleControls.classList.add('collapsed');
        scheduleTitle.classList.add('collapsed');
    }
    
    // Save visibility state to localStorage
    localStorage.setItem('schedule_visibility', JSON.stringify(scheduleVisibility));
}

// Load saved visibility state
function loadScheduleVisibility() {
    const savedVisibility = localStorage.getItem('schedule_visibility');
    if (savedVisibility) {
        try {
            scheduleVisibility = JSON.parse(savedVisibility);
            
            // Apply saved visibility states
            Object.keys(scheduleVisibility).forEach(device => {
                const scheduleControls = document.getElementById(`schedule-controls-${device}`);
                const scheduleTitle = document.querySelector(`#schedule-controls-${device}`)?.previousElementSibling;
                
                if (scheduleControls && scheduleTitle) {
                    if (scheduleVisibility[device]) {
                        // Show
                        scheduleControls.classList.remove('collapsed');
                        scheduleTitle.classList.remove('collapsed');
                    } else {
                        // Hide
                        scheduleControls.classList.add('collapsed');
                        scheduleTitle.classList.add('collapsed');
                    }
                }
            });
        } catch (e) {
            console.error('Error loading schedule visibility:', e);
            scheduleVisibility = {};
        }
    }
    
    // Set default visibility for devices not in saved state
    const allScheduleContainers = document.querySelectorAll('[id^="schedule-controls-"]');
    allScheduleContainers.forEach(container => {
        const device = container.id.replace('schedule-controls-', '');
        if (scheduleVisibility[device] === undefined) {
            scheduleVisibility[device] = true; // Default to visible
        }
    });
}

// Load saved schedules from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load visibility state first
    loadScheduleVisibility();
    // Then load and initialize any saved schedules
    loadSavedSchedules();
});

function loadSavedSchedules() {
    // Load schedules from server instead of localStorage
    fetch('/revpi-schedule/all')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const serverSchedules = data.schedules;
            deviceSchedules = {};
            
            // Convert server format to client format and restore UI
            Object.keys(serverSchedules).forEach(deviceId => {
                const serverSchedule = serverSchedules[deviceId];
                const clientSchedule = {
                    days: serverSchedule.days,
                    startTime: serverSchedule.start_time,
                    endTime: serverSchedule.end_time,
                    enabled: serverSchedule.enabled
                };
                
                deviceSchedules[deviceId] = clientSchedule;
                
                // Restore UI state
                restoreScheduleUI(deviceId, clientSchedule);
                
                // If schedule is enabled, start it
                if (clientSchedule.enabled) {
                    enableSchedule(deviceId, false); // false = don't save to server again
                }
            });
        } else {
            console.log('No schedules found on server or error loading schedules');
            deviceSchedules = {};
        }
    })
    .catch(error => {
        console.error('Error loading schedules from server:', error);
        // Fallback to localStorage if server fails
        console.log('Falling back to localStorage...');
        const savedSchedules = localStorage.getItem('revpi_schedules');
        if (savedSchedules) {
            try {
                deviceSchedules = JSON.parse(savedSchedules);
                // Restore UI state for each saved schedule
                Object.keys(deviceSchedules).forEach(device => {
                    const schedule = deviceSchedules[device];
                    if (schedule) {
                        restoreScheduleUI(device, schedule);
                        if (schedule.enabled) {
                            enableSchedule(device, false); // false = don't save again
                        }
                    }
                });
            } catch (e) {
                console.error('Error loading saved schedules from localStorage:', e);
                deviceSchedules = {};
            }
        } else {
            deviceSchedules = {};
        }
    });
}

function restoreScheduleUI(device, schedule) {
    // Restore day checkboxes
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    days.forEach(day => {
        const checkbox = document.getElementById(`day-${day}-${device}`);
        if (checkbox && schedule.days) {
            checkbox.checked = schedule.days.includes(day);
        }
    });
    
    // Restore time inputs
    const startTimeInput = document.getElementById(`start-time-${device}`);
    const endTimeInput = document.getElementById(`end-time-${device}`);
    if (startTimeInput && schedule.startTime) startTimeInput.value = schedule.startTime;
    if (endTimeInput && schedule.endTime) endTimeInput.value = schedule.endTime;
    
    // Update schedule display
    updateScheduleDisplay(device, schedule);
}

function saveSchedule(device) {
    const startTime = document.getElementById(`start-time-${device}`).value;
    const endTime = document.getElementById(`end-time-${device}`).value;
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Validate times
    if (!startTime || !endTime) {
        alert('Please set both start and end times');
        return;
    }
    
    if (startTime >= endTime) {
        alert('End time must be after start time');
        return;
    }
    
    // Get selected days
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const selectedDays = days.filter(day => 
        document.getElementById(`day-${day}-${device}`).checked
    );
    
    if (selectedDays.length === 0) {
        alert('Please select at least one day');
        return;
    }
    
    // Show saving status
    statusDiv.className = 'schedule-status warning';
    statusDiv.textContent = 'Saving schedule...';
    
    // Save schedule to server
    const scheduleData = {
        device_id: device,
        start_time: startTime,
        end_time: endTime,
        days: selectedDays,
        enabled: false
    };
    
    fetch('/revpi-schedule/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update local cache
            deviceSchedules[device] = {
                days: selectedDays,
                startTime: startTime,
                endTime: endTime,
                enabled: false
            };
            
            // Update UI
            statusDiv.className = 'schedule-status warning';
            statusDiv.textContent = 'Schedule Saved - Click Enable to activate';
            updateScheduleDisplay(device, deviceSchedules[device]);
            
            // Clear message after 3 seconds
            setTimeout(() => {
                if (!deviceSchedules[device].enabled) {
                    statusDiv.className = 'schedule-status inactive';
                    statusDiv.textContent = 'Schedule Inactive';
                }
            }, 3000);
        } else {
            statusDiv.className = 'schedule-status warning';
            statusDiv.textContent = `Error: ${data.message}`;
            setTimeout(() => {
                statusDiv.className = 'schedule-status inactive';
                statusDiv.textContent = 'Schedule Inactive';
            }, 5000);
        }
    })
    .catch(error => {
        console.error('Error saving schedule:', error);
        statusDiv.className = 'schedule-status warning';
        statusDiv.textContent = 'Error: Failed to save schedule';
        setTimeout(() => {
            statusDiv.className = 'schedule-status inactive';
            statusDiv.textContent = 'Schedule Inactive';
        }, 5000);
    });
}

function enableSchedule(device, shouldSave = true) {
    const schedule = deviceSchedules[device];
    if (!schedule) {
        alert('Please save a schedule first');
        return;
    }
    
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    if (shouldSave) {
        // Enable schedule on server
        statusDiv.textContent = 'Enabling schedule...';
        
        fetch('/revpi-schedule/enable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: device,
                enabled: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                enableScheduleUI(device);
            } else {
                statusDiv.className = 'schedule-status warning';
                statusDiv.textContent = `Error: ${data.message}`;
                setTimeout(() => {
                    statusDiv.className = 'schedule-status inactive';
                    statusDiv.textContent = 'Schedule Inactive';
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error enabling schedule:', error);
            statusDiv.className = 'schedule-status warning';
            statusDiv.textContent = 'Error: Failed to enable schedule';
            setTimeout(() => {
                statusDiv.className = 'schedule-status inactive';
                statusDiv.textContent = 'Schedule Inactive';
            }, 3000);
        });
    } else {
        // Called from page load - just update UI
        enableScheduleUI(device);
    }
}

function enableScheduleUI(device) {
    const schedule = deviceSchedules[device];
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Update local schedule state
    schedule.enabled = true;
    
    // Update UI
    enableBtn.disabled = true;
    disableBtn.disabled = false;
    statusDiv.className = 'schedule-status active';
    statusDiv.textContent = 'Schedule Enabled - Checking...';
    
    // Show device time display
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'block';
    }
    
    // Start schedule checker
    startScheduleChecker(device);
    
    // Initial status update (immediate)
    setTimeout(() => {
        updateScheduleStatus(device);
    }, 1000);
}

function disableSchedule(device) {
    const schedule = deviceSchedules[device];
    if (!schedule) return;
    
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Disable schedule on server
    statusDiv.textContent = 'Disabling schedule...';
    
    fetch('/revpi-schedule/enable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device_id: device,
            enabled: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            disableScheduleUI(device);
        } else {
            statusDiv.className = 'schedule-status warning';
            statusDiv.textContent = `Error: ${data.message}`;
            setTimeout(() => {
                statusDiv.className = 'schedule-status active';
                statusDiv.textContent = 'Schedule Active';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error disabling schedule:', error);
        statusDiv.className = 'schedule-status warning';
        statusDiv.textContent = 'Error: Failed to disable schedule';
        setTimeout(() => {
            statusDiv.className = 'schedule-status active';
            statusDiv.textContent = 'Schedule Active';
        }, 3000);
    });
}

function disableScheduleUI(device) {
    const schedule = deviceSchedules[device];
    const enableBtn = document.getElementById(`enable-schedule-${device}`);
    const disableBtn = document.getElementById(`disable-schedule-${device}`);
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Update local schedule state
    schedule.enabled = false;
    
    // Stop schedule checker
    if (scheduleCheckers[device]) {
        clearInterval(scheduleCheckers[device]);
        delete scheduleCheckers[device];
    }
    
    // Update UI
    enableBtn.disabled = false;
    disableBtn.disabled = true;
    statusDiv.className = 'schedule-status inactive';
    statusDiv.textContent = 'Schedule Disabled';
    
    // Hide device time display
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'none';
    }
}

function startScheduleChecker(device) {
    // Clear existing checker
    if (scheduleCheckers[device]) {
        clearInterval(scheduleCheckers[device]);
    }
    
    // Start with frequent checks (every 30 seconds) for the first 5 minutes
    // then reduce to every minute for ongoing monitoring
    let checkCount = 0;
    const maxFrequentChecks = 10; // 5 minutes worth at 30-second intervals
    
    scheduleCheckers[device] = setInterval(() => {
        updateScheduleStatus(device);
        checkCount++;
        
        // After frequent checks, switch to less frequent checking
        if (checkCount >= maxFrequentChecks) {
            clearInterval(scheduleCheckers[device]);
            // Switch to minute-based checking
            scheduleCheckers[device] = setInterval(() => {
                updateScheduleStatus(device);
            }, 60000);
        }
    }, 30000); // Check every 30 seconds initially
}

function updateScheduleStatus(device) {
    const schedule = deviceSchedules[device];
    if (!schedule || !schedule.enabled) return;
    
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    const deviceTimeDiv = document.getElementById(`device-time-${device}`);
    const deviceTimeDisplay = document.getElementById(`device-time-display-${device}`);
    
    // Show device time display when schedule is active
    if (deviceTimeDiv) {
        deviceTimeDiv.style.display = 'block';
    }
    
    // Fetch device time from RevPi
    fetch('/revpi-time')
    .then(response => response.json())
    .then(timeData => {
        if (timeData.success) {
            const currentDay = timeData.day; // 'mon', 'tue', etc.
            const currentTime = timeData.time; // 'HH:MM'
            
            // Update device time display
            if (deviceTimeDisplay) {
                deviceTimeDisplay.textContent = `${timeData.formatted_time} (${currentDay.toUpperCase()})`;
            }
            
            processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
        } else {
            // Fallback to client time if server time fails
            console.warn('Failed to get device time, falling back to client time');
            if (deviceTimeDisplay) {
                deviceTimeDisplay.textContent = 'Device time unavailable - using client time';
            }
            
            const now = new Date();
            const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            
            processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
        }
    })
    .catch(error => {
        console.error('Error fetching device time:', error);
        if (deviceTimeDisplay) {
            deviceTimeDisplay.textContent = 'Error getting device time';
        }
        
        // Fallback to client time on error
        const now = new Date();
        const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
        
        processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv);
    });
}

function processScheduleLogic(device, schedule, currentDay, currentTime, statusDiv) {
    
    // Check if today is a scheduled day
    if (!schedule.days.includes(currentDay)) {
        statusDiv.textContent = `Schedule Active - Off day (${currentDay.toUpperCase()})`;
        // Turn off on non-scheduled days
        executeScheduleAction(device, 'off');
        return;
    }
    
    // Check if current time is within schedule
    const isInSchedule = currentTime >= schedule.startTime && currentTime < schedule.endTime;
    
    if (isInSchedule) {
        statusDiv.textContent = `Schedule Active - ON period (${schedule.startTime}-${schedule.endTime})`;
        // Auto-turn on during scheduled time
        executeScheduleAction(device, 'on');
    } else {
        statusDiv.textContent = `Schedule Active - OFF period (${schedule.startTime}-${schedule.endTime})`;
        // Auto-turn off outside scheduled time
        executeScheduleAction(device, 'off');
    }
}

function executeScheduleAction(device, action) {
    // Get current device status to avoid unnecessary toggles
    const currentStatusElement = document.getElementById(`status-text-${device}`);
    const currentStatus = currentStatusElement ? currentStatusElement.textContent : '';
    const statusDiv = document.getElementById(`schedule-status-${device}`);
    
    // Only execute if we need to change the state
    const shouldExecute = (action === 'on' && currentStatus !== 'ON') || 
                         (action === 'off' && currentStatus !== 'OFF');
    
    if (shouldExecute) {
        // Show that action is being taken
        const originalText = statusDiv.textContent;
        statusDiv.textContent = `Executing: Turning ${action.toUpperCase()}...`;
        
        // Use a simplified version of toggleDevice that doesn't interfere with UI
        fetch('/revpi-toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device: device,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Schedule executed: ${device} turned ${action.toUpperCase()}`);
                // Update status immediately
                setTimeout(updateStatus, 1000);
                
                // Restore status message after action
                setTimeout(() => {
                    if (statusDiv.textContent.includes('Executing:')) {
                        updateScheduleStatus(device);
                    }
                }, 2000);
            } else {
                console.error(`Schedule execution failed for ${device}: ${data.message}`);
                statusDiv.textContent = `Error: ${data.message}`;
                // Restore original status after error
                setTimeout(() => {
                    statusDiv.textContent = originalText;
                }, 3000);
            }
        })
        .catch(error => {
            console.error(`Schedule execution error for ${device}:`, error);
            statusDiv.textContent = 'Error: Connection failed';
            // Restore original status after error
            setTimeout(() => {
                statusDiv.textContent = originalText;
            }, 3000);
        });
    }
}

function updateScheduleDisplay(device, schedule) {
    const scheduleDiv = document.getElementById(`current-schedule-${device}`);
    const detailsSpan = document.getElementById(`schedule-details-${device}`);
    
    if (schedule && schedule.days && schedule.startTime && schedule.endTime) {
        const dayNames = {
            'mon': 'Mon', 'tue': 'Tue', 'wed': 'Wed', 'thu': 'Thu',
            'fri': 'Fri', 'sat': 'Sat', 'sun': 'Sun'
        };
        
        const dayStr = schedule.days.map(day => dayNames[day]).join(', ');
        detailsSpan.textContent = `${dayStr}: ${schedule.startTime} - ${schedule.endTime}`;
        scheduleDiv.style.display = 'block';
    } else {
        detailsSpan.textContent = 'No schedule set';
        scheduleDiv.style.display = 'none';
    }
}

// Stop all schedule checkers when page is unloaded
window.addEventListener('beforeunload', function() {
    Object.keys(scheduleCheckers).forEach(device => {
        if (scheduleCheckers[device]) {
            clearInterval(scheduleCheckers[device]);
        }
    });
});
</script>
{% endblock %}
