{% extends "base.html" %}

{% block title %}Config Editor - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #005596;
        min-height: 100vh;
    }
    .header {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .logo {
        max-height: 50px;
        height: auto;
    }
    .user-info {
        color: #005596;
        font-weight: bold;
    }
    .logout-button {
        background-color: #e74a3b;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        margin-left: 15px;
    }
    .logout-button:hover {
        background-color: #c0392b;
        text-decoration: none;
        color: white;
    }
    .nav-tabs {
        background-color: white;
        padding: 0;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .tab-button {
        flex: 1;
        padding: 15px 20px;
        background-color: white;
        color: #005596;
        text-decoration: none;
        text-align: center;
        font-weight: bold;
        border-right: 1px solid #e3e6f0;
        transition: all 0.3s;
    }
    .tab-button:last-child {
        border-right: none;
    }
    .tab-button:hover {
        background-color: #f8f9fc;
        text-decoration: none;
        color: #005596;
    }
    .tab-button.active {
        background-color: #005596;
        color: white;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    .title {
        color: #005596;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
    }
    .config-info {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .config-path {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 5px 10px;
        border-radius: 5px;
        color: #495057;
    }
    
    /* Form styles */
    .device-section, .settings-section {
        background: #f8f9fc;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #005596;
    }
    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 15px;
        border-bottom: 2px solid #005596;
        padding-bottom: 5px;
    }
    .device-name {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        margin: 15px 0 10px 0;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-row {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .form-row label {
        min-width: 200px;
        font-weight: bold;
        color: #495057;
    }
    .form-control {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 14px;
    }
    .form-control:focus {
        outline: none;
        border-color: #005596;
        box-shadow: 0 0 0 2px rgba(0,85,150,0.25);
    }
    
    .button-container {
        text-align: center;
        margin: 20px 0;
    }
    .action-button {
        background-color: #005596;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        margin: 0 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s;
    }
    .action-button:hover {
        background-color: #004080;
        transform: translateY(-1px);
    }
    .action-button.save {
        background-color: #28a745;
    }
    .action-button.save:hover {
        background-color: #218838;
    }
    .action-button.reset {
        background-color: #dc3545;
    }
    .action-button.reset:hover {
        background-color: #c82333;
    }
    .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        display: none;
    }
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .loading {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 20px;
    }
</style>
{% endblock %}

{% block body %}
<div class="header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <div>
        <span class="user-info">Welcome, {{ session.username }}!</span>
        <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>
    </div>
</div>

<div class="nav-tabs">
    <a href="{{ url_for('main.service_monitor') }}" class="tab-button">Service Monitor</a>
    <a href="{{ url_for('main.revpi_control') }}" class="tab-button">RevPi Control</a>
    <a href="{{ url_for('main.config_editor') }}" class="tab-button active">Config Editor</a>
</div>

<div class="container">
    <h1 class="title">Interactive Configuration Editor</h1>
    
    <div class="config-info" style="display: none;">
        <strong>Configuration File:</strong> 
        <span class="config-path">/home/pi/jebi-switchboard/config/strict_log_config.json</span>
    </div>
    
    <div id="loading" class="loading">Loading configuration...</div>
    
    <div id="editor-section" style="display: none;">
        <!-- Device Configurations -->
        <div class="device-section">
            <div class="section-title">Device Configurations</div>
            
            <div class="device-name">RelayProcessor</div>
            <div class="form-group">
                <div class="form-row">
                    <label for="relayProcessorName">Device Name:</label>
                    <input type="text" id="relayProcessorName" class="form-control" value="RelayProcessor">
                </div>
            </div>
            <div class="form-group">
                <div class="form-row">
                    <label for="relayProcessorIp">IP Address:</label>
                    <input type="text" id="relayProcessorIp" class="form-control" value="192.168.1.100">
                </div>
            </div>
            
            <div class="device-name">RelayScreen</div>
            <div class="form-group">
                <div class="form-row">
                    <label for="relayScreenName">Device Name:</label>
                    <input type="text" id="relayScreenName" class="form-control" value="RelayScreen">
                </div>
            </div>
            <div class="form-group">
                <div class="form-row">
                    <label for="relayScreenIp">IP Address:</label>
                    <input type="text" id="relayScreenIp" class="form-control" value="192.168.1.101">
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div class="settings-section">
            <div class="section-title">System Settings</div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="checkInterval">Check Interval (seconds):</label>
                    <input type="number" id="checkInterval" class="form-control" value="10" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="failWindow">Failure Window:</label>
                    <input type="number" id="failWindow" class="form-control" value="3" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="offSeconds">Off Time (seconds):</label>
                    <input type="number" id="offSeconds" class="form-control" value="10" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="rebootWait">Reboot Wait (seconds):</label>
                    <input type="number" id="rebootWait" class="form-control" value="70" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="maxPowerCycles">Max Power Cycles:</label>
                    <input type="number" id="maxPowerCycles" class="form-control" value="3" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="logLevel">Log Level:</label>
                    <select id="logLevel" class="form-control">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="logFile">Log File Path:</label>
                    <input type="text" id="logFile" class="form-control" value="/var/log/jebi-switchboard/check_alive_strict.log" style="display: none;">
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <label for="startupDelay">Startup Delay (seconds):</label>
                    <input type="number" id="startupDelay" class="form-control" value="15" min="0">
                </div>
            </div>
        </div>
        
        <div class="button-container">
            <button class="action-button" onclick="loadConfig()" id="load-btn">
                🔄 Reload
            </button>
            <button class="action-button save" onclick="saveConfig()" id="save-btn">
                💾 Save Configuration
            </button>
            <button class="action-button reset" onclick="resetForm()" id="reset-btn">
                ↩️ Reset Form
            </button>
        </div>
        
        <div id="status-message" class="status-message"></div>
    </div>
</div>

<script>
let originalConfig = {};

function showStatus(message, type = 'info') {
    const statusElement = document.getElementById('status-message');
    statusElement.textContent = message;
    statusElement.className = `status-message status-${type}`;
    statusElement.style.display = 'block';
    
    setTimeout(() => {
        statusElement.style.display = 'none';
    }, 5000);
}

function setButtonsEnabled(enabled) {
    const buttons = ['load-btn', 'save-btn', 'reset-btn'];
    buttons.forEach(btnId => {
        document.getElementById(btnId).disabled = !enabled;
    });
}

function populateForm(config) {
    // Device configurations
    if (config.RelayProcessor) {
        document.getElementById('relayProcessorName').value = config.RelayProcessor.name || '';
        document.getElementById('relayProcessorIp').value = config.RelayProcessor.ip || '';
    }
    if (config.RelayScreen) {
        document.getElementById('relayScreenName').value = config.RelayScreen.name || '';
        document.getElementById('relayScreenIp').value = config.RelayScreen.ip || '';
    }
    
    // System settings
    document.getElementById('checkInterval').value = config.CHECK_INTERVAL_SEC || 10;
    document.getElementById('failWindow').value = config.FAIL_WINDOW || 3;
    document.getElementById('offSeconds').value = config.OFF_SECONDS || 10;
    document.getElementById('rebootWait').value = config.REBOOT_WAIT_SEC || 70;
    document.getElementById('maxPowerCycles').value = config.MAX_POWER_CYCLES || 3;
    document.getElementById('logLevel').value = config.LOG_LEVEL || 'INFO';
    document.getElementById('logFile').value = config.LOG_FILE || '';
    document.getElementById('startupDelay').value = config.STARTUP_DELAY_SEC || 15;
}

function collectFormData() {
    return {
        "RelayProcessor": {
            "name": document.getElementById('relayProcessorName').value,
            "ip": document.getElementById('relayProcessorIp').value
        },
        "RelayScreen": {
            "name": document.getElementById('relayScreenName').value,
            "ip": document.getElementById('relayScreenIp').value
        },
        "CHECK_INTERVAL_SEC": parseInt(document.getElementById('checkInterval').value),
        "FAIL_WINDOW": parseInt(document.getElementById('failWindow').value),
        "OFF_SECONDS": parseInt(document.getElementById('offSeconds').value),
        "REBOOT_WAIT_SEC": parseInt(document.getElementById('rebootWait').value),
        "MAX_POWER_CYCLES": parseInt(document.getElementById('maxPowerCycles').value),
        "LOG_LEVEL": document.getElementById('logLevel').value,
        "LOG_FILE": document.getElementById('logFile').value,
        "STARTUP_DELAY_SEC": parseInt(document.getElementById('startupDelay').value)
    };
}

function loadConfig() {
    const loading = document.getElementById('loading');
    const editorSection = document.getElementById('editor-section');
    
    loading.style.display = 'block';
    editorSection.style.display = 'none';
    setButtonsEnabled(false);
    
    fetch('/config-data')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            editorSection.style.display = 'block';
            setButtonsEnabled(true);
            
            if (data.success) {
                originalConfig = data.data;
                populateForm(data.data);
                showStatus('Configuration loaded successfully', 'success');
            } else {
                showStatus(`Error loading configuration: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            setButtonsEnabled(true);
            showStatus(`Network error: ${error.message}`, 'error');
        });
}

function saveConfig() {
    const configData = collectFormData();
    
    setButtonsEnabled(false);
    const saveBtn = document.getElementById('save-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    
    fetch('/config-save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            config_data: configData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            originalConfig = configData;
            showStatus(data.message, 'success');
        } else {
            showStatus(`Save failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showStatus(`Network error: ${error.message}`, 'error');
    })
    .finally(() => {
        setButtonsEnabled(true);
        saveBtn.textContent = originalText;
    });
}

function resetForm() {
    populateForm(originalConfig);
    showStatus('Form reset to last loaded configuration', 'success');
}

// Load configuration on page load
loadConfig();
</script>
{% endblock %}
