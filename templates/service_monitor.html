{% extends "base.html" %}

{% block title %}Service Monitor - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    body {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #005596;
        min-height: 100vh;
    }
    .header {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .logo {
        max-height: 50px;
        height: auto;
    }
    .user-info {
        color: #005596;
        font-weight: bold;
    }
    .logout-button {
        background-color: #e74a3b;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        margin-left: 15px;
    }
    .logout-button:hover {
        background-color: #c0392b;
        text-decoration: none;
        color: white;
    }
    .nav-tabs {
        background-color: white;
        padding: 0;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .tab-button {
        flex: 1;
        padding: 15px 20px;
        background-color: white;
        color: #005596;
        text-decoration: none;
        text-align: center;
        font-weight: bold;
        border-right: 1px solid #e3e6f0;
        transition: all 0.3s;
    }
    .tab-button:last-child {
        border-right: none;
    }
    .tab-button:hover {
        background-color: #f8f9fc;
        text-decoration: none;
        color: #005596;
    }
    .tab-button.active {
        background-color: #005596;
        color: white;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: start;
    }

    @media (max-width: 1200px) {
        .container {
            grid-template-columns: 1fr;
        }
    }

    .service-column {
        display: flex;
        flex-direction: column;
    }

    .config-column {
        display: flex;
        flex-direction: column;
    }
    .title {
        color: #005596;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 30px;
    }

    .column-title {
        color: #005596;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #005596;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s;
        position: relative;
    }
    .column-title:hover {
        background-color: #f8f9fc;
        padding: 10px;
        border-radius: 8px;
    }
    .column-toggle-btn {
        background-color: #005596;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.3s;
        flex-shrink: 0;
    }
    .column-toggle-btn:hover {
        background-color: #004080;
        transform: scale(1.1);
    }
    .column-toggle-btn.collapsed {
        transform: rotate(180deg);
    }
    .column-content {
        transition: all 0.3s ease;
        max-height: 5000px;
        overflow: hidden;
        opacity: 1;
    }
    .column-content.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding: 0;
    }
    .service-column.minimal,
    .config-column.minimal {
        flex: 0 0 auto;
        width: auto;
        min-width: 300px;
    }
    .service-card {
        background-color: #f8f9fc;
        border: 2px solid #e3e6f0;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        transition: all 0.3s;
    }
    .service-card.active {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    .service-card.inactive {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    .service-name {
        font-size: 24px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 15px;
        text-align: center;
    }
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    @media (max-width: 1200px) {
        .status-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    .status-item {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e3e6f0;
        text-align: center;
    }
    .status-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .status-value {
        font-size: 16px;
        font-weight: bold;
        color: #2d3436;
    }
    .status-indicator {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .status-active {
        background-color: #28a745;
        animation: pulse 2s infinite;
    }
    .status-inactive {
        background-color: #dc3545;
    }
    .status-unknown {
        background-color: #ffc107;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    .last-updated {
        text-align: center;
        color: #6c757d;
        font-size: 14px;
        margin-top: 20px;
    }
    .service-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    @media (max-width: 1200px) {
        .service-actions {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
        }
    }
    .action-button {
        background-color: #005596;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        width: 100%;
    }

    @media (max-width: 1200px) {
        .action-button {
            width: auto;
            margin: 0 5px;
        }
    }
    .action-button:hover {
        background-color: #004080;
        transform: translateY(-1px);
    }
    .action-button.restart {
        background-color: #ffc107;
        color: #000;
    }
    .action-button.restart:hover {
        background-color: #e6ac00;
    }
    .action-button.stop {
        background-color: #dc3545;
    }
    .action-button.stop:hover {
        background-color: #c82333;
    }
    .action-button.start {
        background-color: #28a745;
    }
    .action-button.start:hover {
        background-color: #218838;
    }
    .loading {
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }

    /* Config Editor Styles */
    .config-section {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .config-info {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .config-path {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 5px 10px;
        border-radius: 5px;
        color: #495057;
    }
    .device-section, .settings-section {
        background: #f8f9fc;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #005596;
    }
    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #005596;
        margin-bottom: 15px;
        border-bottom: 2px solid #005596;
        padding-bottom: 5px;
    }
    .device-name-config {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        margin: 15px 0 10px 0;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-row {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .form-row label {
        min-width: 200px;
        font-weight: bold;
        color: #495057;
    }
    .form-control {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 14px;
    }
    .form-control:focus {
        outline: none;
        border-color: #005596;
        box-shadow: 0 0 0 2px rgba(0,85,150,0.25);
    }
    .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
        color: #6c757d;
    }
    .button-container {
        text-align: center;
        margin: 20px 0;
    }
    .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        display: none;
    }
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        background-color: #005596;
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h2 {
        margin: 0;
        font-size: 24px;
    }
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    .close:hover {
        color: #F3CB3C;
    }
    .modal-body {
        padding: 20px;
    }
    .log-path {
        background-color: #f8f9fc;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-family: monospace;
        color: #005596;
        font-weight: bold;
    }
    .log-files {
        margin-top: 15px;
    }
    .log-file-item {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .log-file-info {
        flex: 1;
    }
    .log-file-name {
        font-weight: bold;
        color: #005596;
        margin-bottom: 5px;
    }
    .log-file-period {
        font-size: 13px;
        color: #28a745;
        font-weight: 500;
        margin: 3px 0;
        padding: 3px 0;
    }
    .log-file-details {
        font-size: 12px;
        color: #6c757d;
    }
    .log-file-download {
        background-color: #28a745;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    .log-file-download:hover {
        background-color: #218838;
        text-decoration: none;
        color: white;
    }
    .log-file-download.disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
    }
    
    /* File Selection Styles */
    .file-selection-controls {
        background-color: #f8f9fc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #e3e6f0;
    }
    .selection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .selection-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .selection-button {
        background-color: #005596;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    .selection-button:hover {
        background-color: #004080;
    }
    .selection-button.secondary {
        background-color: #6c757d;
    }
    .selection-button.secondary:hover {
        background-color: #5a6268;
    }
    .selection-button.download {
        background-color: #28a745;
    }
    .selection-button.download:hover {
        background-color: #218838;
    }
    .selection-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }
    .file-checkbox {
        margin-right: 10px;
        transform: scale(1.2);
    }
    .log-file-item {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
    }
    .log-file-item:hover {
        background-color: #e9ecef;
    }
    .log-file-item.selected {
        border-color: #005596;
        background-color: #e8f4fd;
    }
    .log-file-main {
        display: flex;
        align-items: center;
        flex: 1;
    }
</style>
{% endblock %}

{% block body %}
<div class="header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <div>
        <span class="user-info">Welcome, {{ session.username }}!</span>
        <a href="{{ url_for('auth.logout') }}" class="logout-button">Logout</a>
    </div>
</div>

<div class="nav-tabs">
    <a href="{{ url_for('main.service_monitor') }}" class="tab-button active">Service Monitor & Config</a>
    <a href="{{ url_for('main.revpi_control') }}" class="tab-button">RevPi Control</a>
</div>

<div class="container">
    <!-- Service Monitor Column -->
    <div class="service-column minimal" id="service-column">
        <h2 class="column-title" onclick="toggleColumn('service')">
            <span class="status-indicator status-unknown" id="title-status-indicator"></span>
            Service Monitor
            <button class="column-toggle-btn collapsed" id="service-toggle">▲</button>
        </h2>

        <div class="column-content collapsed" id="service-content">
        <div id="service-container">
            <div class="service-card" id="service-card">
                <div class="service-name">jebi-switchboard-guard.service</div>
                <div class="loading" id="loading">Loading service status...</div>

                <div id="service-status" style="display: none;">
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Status</div>
                            <div class="status-value">
                                <span class="status-indicator" id="status-indicator"></span>
                                <span id="status-text">Unknown</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Active</div>
                            <div class="status-value" id="active-status">Unknown</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Enabled</div>
                            <div class="status-value" id="enabled-status">Unknown</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Uptime</div>
                            <div class="status-value" id="uptime">N/A</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Memory Usage</div>
                            <div class="status-value" id="memory-usage">N/A</div>
                        </div>
                    </div>

                    <div class="status-item" style="margin-top: 15px;">
                        <div class="status-label">Last Log Entry</div>
                        <div class="status-value" id="last-log" style="font-size: 12px; word-break: break-all;">N/A</div>
                    </div>

                    <div class="service-actions">
                        <button class="action-button start" onclick="controlService('start')" id="start-btn">Start Service</button>
                        <button class="action-button stop" onclick="controlService('stop')" id="stop-btn">Stop Service</button>
                        <!--<button class="action-button restart" onclick="controlService('restart')" id="restart-btn">Restart Service</button>-->
                    </div>
                </div>
            </div>
        </div>

        <div class="last-updated" id="last-updated">
            Last updated: Never
        </div>
        </div>
    </div>

    <!-- Configuration Editor Column -->
    <div class="config-column minimal" id="config-column">
        <h2 class="column-title" onclick="toggleColumn('config')">
            Configuration Editor
            <button class="column-toggle-btn collapsed" id="config-toggle">▲</button>
        </h2>

        <div class="column-content collapsed" id="config-content">
        <div class="config-section">

        <div class="config-info" style="display: none;">
            <strong>Configuration File:</strong>
            <span class="config-path">/home/pi/jebi-switchboard/config/strict_log_config.json</span>
        </div>

        <div id="config-loading" class="loading">Loading configuration...</div>

        <div id="config-editor-section" style="display: none;">
            <!-- Device Configurations -->
            <div class="device-section">
                <div class="section-title">Device Configurations</div>

                <div class="device-name-config">RelayProcessor</div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="relayProcessorName">Device Name:</label>
                        <input type="text" id="relayProcessorName" class="form-control" value="RelayProcessor" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="relayProcessorIp">IP Address:</label>
                        <input type="text" id="relayProcessorIp" class="form-control" value="192.168.1.100">
                    </div>
                </div>

                <div class="device-name-config">RelayScreen</div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="relayScreenName">Device Name:</label>
                        <input type="text" id="relayScreenName" class="form-control" value="RelayScreen" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row">
                        <label for="relayScreenIp">IP Address:</label>
                        <input type="text" id="relayScreenIp" class="form-control" value="192.168.1.101">
                    </div>
                </div>
            </div>

            <!-- System Settings -->
            <div class="settings-section">
                <div class="section-title">System Settings</div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="checkInterval">Check Interval (seconds):</label>
                        <input type="number" id="checkInterval" class="form-control" value="10" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="failWindow">Failure Window:</label>
                        <input type="number" id="failWindow" class="form-control" value="3" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="offSeconds">Off Time (seconds):</label>
                        <input type="number" id="offSeconds" class="form-control" value="10" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="rebootWait">Reboot Wait (seconds):</label>
                        <input type="number" id="rebootWait" class="form-control" value="70" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="maxPowerCycles">Max Power Cycles:</label>
                        <input type="number" id="maxPowerCycles" class="form-control" value="3" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="logLevel">Log Level:</label>
                        <select id="logLevel" class="form-control">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO" selected>INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="logDirectory">Log Directory:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
                            <!--<input type="text" id="logDirectory" class="form-control" value="/var/log/jebi-switchboard" readonly style="flex: 1;">-->
                            <button type="button" class="action-button" onclick="openLogDirectory()" id="browse-logs-btn">
                                Browse Files
                            </button>
                        </div>
                    </div>
                </div>

                 <div class="form-group">
                    <div class="form-row">
                        <input type="text" id="logFile" class="form-control" value="/var/log/jebi-switchboard/check_alive_strict.log" style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <label for="startupDelay">Startup Delay (seconds):</label>
                        <input type="number" id="startupDelay" class="form-control" value="15" min="0">
                    </div>
                </div>
            </div>

            <div class="button-container">
                <!--<button class="action-button" onclick="loadConfig()" id="load-btn">
                    Reload
                </button>-->
                <button class="action-button save" onclick="saveConfig()" id="save-btn">
                    Save Configuration and Restart Service
                </button>
                <!--<button class="action-button reset" onclick="resetForm()" id="reset-btn">
                    Reset Form
                </button>-->
            </div>

            <div id="config-status-message" class="status-message"></div>
        </div>
        </div>
        </div>
    </div>
</div>

<!-- Log Directory Browser Modal -->
<div id="logModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Log Directory Browser</h2>
            <span class="close" onclick="closeLogModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="logPath" class="log-path"></div>
            <div id="logLoading" class="loading" style="display: none;">Loading files...</div>
            <div id="logError" class="error-message" style="display: none;"></div>
            
            <div id="fileSelectionControls" class="file-selection-controls" style="display: none;">
                <div class="selection-header">
                    <span id="selectionCount">0 files selected</span>
                    <div class="selection-actions">
                        <button class="selection-button" onclick="selectAllFiles()">Select All</button>
                        <button class="selection-button secondary" onclick="clearSelection()">Clear All</button>
                        <button class="selection-button download" onclick="downloadSelectedFiles()" id="downloadSelectedBtn" disabled>Download Selected</button>
                    </div>
                </div>
            </div>
            
            <div id="logFiles" class="log-files"></div>
        </div>
    </div>
</div>

<script>
let lastUpdateTime = null;

function updateServiceStatus() {
    fetch('/service-status')
        .then(response => response.json())
        .then(data => {
            const loading = document.getElementById('loading');
            const serviceStatus = document.getElementById('service-status');
            const serviceCard = document.getElementById('service-card');
            
            loading.style.display = 'none';
            serviceStatus.style.display = 'block';
            
            if (data.success) {
                // Update status indicator
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                statusText.textContent = data.status;
                
                // Update card style and indicator based on status
                serviceCard.className = 'service-card';
                statusIndicator.className = 'status-indicator';

                // Also update title status indicator
                const titleStatusIndicator = document.getElementById('title-status-indicator');
                if (titleStatusIndicator) {
                    titleStatusIndicator.className = 'status-indicator';
                }

                if (data.active && data.status === 'active') {
                    serviceCard.classList.add('active');
                    statusIndicator.classList.add('status-active');
                    if (titleStatusIndicator) titleStatusIndicator.classList.add('status-active');
                } else if (data.status === 'inactive' || data.status === 'failed') {
                    serviceCard.classList.add('inactive');
                    statusIndicator.classList.add('status-inactive');
                    if (titleStatusIndicator) titleStatusIndicator.classList.add('status-inactive');
                } else {
                    statusIndicator.classList.add('status-unknown');
                    if (titleStatusIndicator) titleStatusIndicator.classList.add('status-unknown');
                }
                
                // Update other status fields
                document.getElementById('active-status').textContent = data.active ? 'Yes' : 'No';
                document.getElementById('enabled-status').textContent = data.enabled ? 'Yes' : 'No';
                document.getElementById('uptime').textContent = data.uptime || 'N/A';
                document.getElementById('memory-usage').textContent = data.memory_usage || 'N/A';
                document.getElementById('last-log').textContent = data.last_log || 'N/A';
                
                lastUpdateTime = new Date();
                document.getElementById('last-updated').textContent = 
                    `Last updated: ${lastUpdateTime.toLocaleTimeString()}`;
            } else {
                // Handle error
                serviceCard.classList.add('inactive');
                document.getElementById('status-text').textContent = 'Error';
                document.getElementById('status-indicator').classList.add('status-inactive');
                console.error('Error fetching service status:', data.error);
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            const loading = document.getElementById('loading');
            loading.textContent = 'Error loading service status';
            loading.style.color = '#dc3545';
        });
}

function controlService(action) {
    const buttons = ['start-btn', 'stop-btn']; // Removed restart-btn since it's commented out
    const actionBtn = document.getElementById(action + '-btn');
    
    if (!actionBtn) {
        console.error(`Button with ID ${action}-btn not found`);
        return;
    }
    
    // Disable all buttons during operation
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = true;
        }
    });
    
    // Show loading state
    const originalText = actionBtn.textContent;
    actionBtn.textContent = action.charAt(0).toUpperCase() + action.slice(1) + 'ing...';
    
    fetch('/service-control', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: action,
            service_name: 'jebi-switchboard-guard.service'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(`Service ${action} successful: ${data.message}`);
            // Refresh status immediately
            updateServiceStatus();
        } else {
            alert(`Service ${action} failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error controlling service:', error);
        alert(`Network error during service ${action}: ${error.message}`);
    })
    .finally(() => {
        // Re-enable buttons and restore text
        buttons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = false;
            }
        });
        actionBtn.textContent = originalText;
    });
}

// Update immediately and then every 10 seconds
updateServiceStatus();
setInterval(updateServiceStatus, 10000);

// ========== Configuration Editor Functions ==========
let originalConfig = {};

function showStatus(message, type = 'info') {
    const statusElement = document.getElementById('config-status-message');
    statusElement.textContent = message;
    statusElement.className = `status-message status-${type}`;
    statusElement.style.display = 'block';

    setTimeout(() => {
        statusElement.style.display = 'none';
    }, 5000);
}

function setButtonsEnabled(enabled) {
    const buttons = ['load-btn', 'save-btn', 'reset-btn'];
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) btn.disabled = !enabled;
    });
}

function populateForm(config) {
    // Helper function to safely set element value
    function setElementValue(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.value = value;
        } else {
            console.warn(`Element with ID '${id}' not found`);
        }
    }

    // Device configurations
    if (config.RelayProcessor) {
        setElementValue('relayProcessorName', config.RelayProcessor.name || '');
        setElementValue('relayProcessorIp', config.RelayProcessor.ip || '');
    }
    if (config.RelayScreen) {
        setElementValue('relayScreenName', config.RelayScreen.name || '');
        setElementValue('relayScreenIp', config.RelayScreen.ip || '');
    }

    // System settings
    setElementValue('checkInterval', config.CHECK_INTERVAL_SEC || 10);
    setElementValue('failWindow', config.FAIL_WINDOW || 3);
    setElementValue('offSeconds', config.OFF_SECONDS || 10);
    setElementValue('rebootWait', config.REBOOT_WAIT_SEC || 70);
    setElementValue('maxPowerCycles', config.MAX_POWER_CYCLES || 3);
    setElementValue('logLevel', config.LOG_LEVEL || 'INFO');
    setElementValue('logFile', config.LOG_FILE || '');
    setElementValue('startupDelay', config.STARTUP_DELAY_SEC || 15);
}

function collectFormData() {
    // Helper function to safely get element value
    function getElementValue(id, defaultValue = '') {
        const element = document.getElementById(id);
        if (element) {
            return element.value;
        } else {
            console.warn(`Element with ID '${id}' not found`);
            return defaultValue;
        }
    }

    return {
        "RelayProcessor": {
            "name": getElementValue('relayProcessorName'),
            "ip": getElementValue('relayProcessorIp')
        },
        "RelayScreen": {
            "name": getElementValue('relayScreenName'),
            "ip": getElementValue('relayScreenIp')
        },
        "CHECK_INTERVAL_SEC": parseInt(getElementValue('checkInterval', '10')),
        "FAIL_WINDOW": parseInt(getElementValue('failWindow', '3')),
        "OFF_SECONDS": parseInt(getElementValue('offSeconds', '10')),
        "REBOOT_WAIT_SEC": parseInt(getElementValue('rebootWait', '70')),
        "MAX_POWER_CYCLES": parseInt(getElementValue('maxPowerCycles', '3')),
        "LOG_LEVEL": getElementValue('logLevel', 'INFO'),
        "LOG_FILE": getElementValue('logFile'),
        "STARTUP_DELAY_SEC": parseInt(getElementValue('startupDelay', '15'))
    };
}

function loadConfig() {
    const loading = document.getElementById('config-loading');
    const editorSection = document.getElementById('config-editor-section');

    loading.style.display = 'block';
    editorSection.style.display = 'none';
    setButtonsEnabled(false);

    fetch('/config-data')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            editorSection.style.display = 'block';
            setButtonsEnabled(true);

            if (data.success) {
                originalConfig = data.data;
                populateForm(data.data);
                showStatus('Configuration loaded successfully', 'success');
            } else {
                showStatus(`Error loading configuration: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            setButtonsEnabled(true);
            showStatus(`Network error: ${error.message}`, 'error');
        });
}

function saveConfig() {
    const configData = collectFormData();

    setButtonsEnabled(false);
    const saveBtn = document.getElementById('save-btn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';

    fetch('/config-save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            config_data: configData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            originalConfig = configData;
            showStatus(data.message, 'success');

            // Now restart the service
            saveBtn.textContent = 'Restarting Service...';
            return fetch('/service-control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'restart',
                    service_name: 'jebi-switchboard-guard.service'
                })
            });
        } else {
            showStatus(`Save failed: ${data.error}`, 'error');
            throw new Error('Configuration save failed');
        }
    })
    .then(response => {
        if (response) {
            return response.json();
        }
    })
    .then(data => {
        if (data) {
            if (data.success) {
                showStatus('Configuration saved and service restarted successfully', 'success');
                // Refresh service status after a short delay
                setTimeout(() => {
                    updateServiceStatus();
                }, 2000);
            } else {
                showStatus(`Configuration saved but service restart failed: ${data.error}`, 'error');
            }
        }
    })
    .catch(error => {
        if (error.message !== 'Configuration save failed') {
            showStatus(`Error: ${error.message}`, 'error');
        }
    })
    .finally(() => {
        setButtonsEnabled(true);
        saveBtn.textContent = originalText;
    });
}

function resetForm() {
    populateForm(originalConfig);
    showStatus('Form reset to last loaded configuration', 'success');
}

// Log Directory Functions
let logFiles = [];
let selectedFiles = new Set();

function openLogDirectory() {
    document.getElementById('logModal').style.display = 'block';
    selectedFiles.clear();
    updateSelectionCount();
    loadLogDirectory();
}

function closeLogModal() {
    document.getElementById('logModal').style.display = 'none';
    selectedFiles.clear();
}

function updateSelectionCount() {
    const count = selectedFiles.size;
    document.getElementById('selectionCount').textContent = `${count} file${count !== 1 ? 's' : ''} selected`;
    document.getElementById('downloadSelectedBtn').disabled = count === 0;
}

function toggleFileSelection(fileName, checkbox) {
    if (checkbox.checked) {
        selectedFiles.add(fileName);
    } else {
        selectedFiles.delete(fileName);
    }
    
    // Update file item styling
    const fileItem = checkbox.closest('.log-file-item');
    if (checkbox.checked) {
        fileItem.classList.add('selected');
    } else {
        fileItem.classList.remove('selected');
    }
    
    updateSelectionCount();
}

function selectAllFiles() {
    selectedFiles.clear();
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => {
        const fileName = checkbox.dataset.fileName;
        if (checkbox.dataset.readable === 'true') {
            checkbox.checked = true;
            selectedFiles.add(fileName);
            checkbox.closest('.log-file-item').classList.add('selected');
        }
    });
    updateSelectionCount();
}

function clearSelection() {
    selectedFiles.clear();
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.closest('.log-file-item').classList.remove('selected');
    });
    updateSelectionCount();
}

function downloadSelectedFiles() {
    if (selectedFiles.size === 0) {
        alert('No files selected for download');
        return;
    }
    
    const btn = document.getElementById('downloadSelectedBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Preparing Download...';
    
    // Create a form to submit the file list for zip download
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/download-selected-logs';
    form.style.display = 'none';
    
    selectedFiles.forEach(fileName => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'files[]';
        input.value = fileName;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // Reset button after a delay
    setTimeout(() => {
        btn.disabled = selectedFiles.size === 0;
        btn.textContent = originalText;
    }, 2000);
}

function loadLogDirectory() {
    const loadingElement = document.getElementById('logLoading');
    const errorElement = document.getElementById('logError');
    const filesElement = document.getElementById('logFiles');
    const pathElement = document.getElementById('logPath');
    const selectionControls = document.getElementById('fileSelectionControls');

    loadingElement.style.display = 'block';
    errorElement.style.display = 'none';
    selectionControls.style.display = 'none';
    filesElement.innerHTML = '';
    pathElement.textContent = '';
    selectedFiles.clear();

    fetch('/log-directory')
        .then(response => response.json())
        .then(data => {
            loadingElement.style.display = 'none';

            if (data.success) {
                pathElement.textContent = `Directory: ${data.log_path}`;
                logFiles = data.files;

                if (data.files.length === 0) {
                    filesElement.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No log files found in this directory.</p>';
                } else {
                    selectionControls.style.display = 'block';
                    let filesHtml = '';
                    data.files.forEach(file => {
                        const sizeText = file.size !== null ? formatFileSize(file.size) : 'Unknown';
                        const dateText = file.modified !== null ? new Date(file.modified * 1000).toLocaleString() : 'Unknown';

                        // Format logging period
                        let logPeriodText = '';
                        if (file.log_period_start && file.log_period_end) {
                            const startDate = new Date(file.log_period_start);
                            const endDate = new Date(file.log_period_end);
                            logPeriodText = `<div class="log-file-period">Logging Period: ${startDate.toLocaleString()} to ${endDate.toLocaleString()}</div>`;
                        } else if (file.log_period_start || file.log_period_end) {
                            const availableDate = file.log_period_start ? new Date(file.log_period_start) : new Date(file.log_period_end);
                            logPeriodText = `<div class="log-file-period">Logging Period: ${availableDate.toLocaleString()}</div>`;
                        }

                        const downloadButton = file.readable
                            ? `<a href="/download-log-file/${encodeURIComponent(file.name)}" class="log-file-download">Download</a>`
                            : `<span class="log-file-download disabled">Not Readable</span>`;

                        const checkbox = file.readable
                            ? `<input type="checkbox" class="file-checkbox" data-file-name="${escapeHtml(file.name)}" data-readable="true" onchange="toggleFileSelection('${escapeHtml(file.name)}', this)">`
                            : `<input type="checkbox" class="file-checkbox" disabled data-readable="false">`;

                        filesHtml += `
                            <div class="log-file-item">
                                <div class="log-file-main">
                                    ${checkbox}
                                    <div class="log-file-info">
                                        <div class="log-file-name">${escapeHtml(file.name)}</div>
                                        ${logPeriodText}
                                        <div class="log-file-details">Size: ${sizeText} | Modified: ${dateText}</div>
                                    </div>
                                </div>
                                ${downloadButton}
                            </div>
                        `;
                    });
                    filesElement.innerHTML = filesHtml;
                }
                updateSelectionCount();
            } else {
                errorElement.textContent = data.error || 'Failed to load log directory';
                errorElement.style.display = 'block';
            }
        })
        .catch(error => {
            loadingElement.style.display = 'none';
            errorElement.textContent = `Error: ${error.message}`;
            errorElement.style.display = 'block';
        });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('logModal');
    if (event.target === modal) {
        closeLogModal();
    }
}

// Load configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();
    // Don't load column states - always start collapsed
    // loadColumnStates();
});

// Column Toggle Functionality
function toggleColumn(columnName) {
    const content = document.getElementById(`${columnName}-content`);
    const toggleBtn = document.getElementById(`${columnName}-toggle`);
    const column = document.getElementById(`${columnName}-column`);

    if (content && toggleBtn) {
        const isCollapsed = content.classList.contains('collapsed');

        if (isCollapsed) {
            // Expand
            content.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            toggleBtn.textContent = '▼';
            column.classList.remove('minimal');
        } else {
            // Collapse
            content.classList.add('collapsed');
            toggleBtn.classList.add('collapsed');
            toggleBtn.textContent = '▲';
            column.classList.add('minimal');
        }

        // Save state to localStorage
        saveColumnState(columnName, !isCollapsed);
    }
}

function saveColumnState(columnName, isExpanded) {
    const columnStates = JSON.parse(localStorage.getItem('columnStates') || '{}');
    columnStates[columnName] = isExpanded;
    localStorage.setItem('columnStates', JSON.stringify(columnStates));
}

function loadColumnStates() {
    const columnStates = JSON.parse(localStorage.getItem('columnStates') || '{}');

    // Apply saved states
    Object.keys(columnStates).forEach(columnName => {
        const isExpanded = columnStates[columnName];
        const content = document.getElementById(`${columnName}-content`);
        const toggleBtn = document.getElementById(`${columnName}-toggle`);
        const column = document.getElementById(`${columnName}-column`);

        if (content && toggleBtn && column) {
            if (!isExpanded) {
                // Collapsed
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleBtn.textContent = '▲';
                column.classList.add('minimal');
            } else {
                // Expanded
                content.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.textContent = '▼';
                column.classList.remove('minimal');
            }
        }
    });
}
</script>
{% endblock %}
